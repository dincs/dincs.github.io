<html>
<title>Report List</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
<script src='https://code.jquery.com/jquery-1.11.0.min.js'></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.7.0/lodash.min.js"></script>
 <script src='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.js'></script>
<link href='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.css' rel='stylesheet' />
<script src="https://cdn.firebase.com/js/client/2.2.3/firebase.js"></script>
<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.43.0/L.Control.Locate.min.js'></script>
<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.43.0/L.Control.Locate.mapbox.css' rel='stylesheet' />
<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-locatecontrol/v0.43.0/css/font-awesome.min.css' rel='stylesheet' />
<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v1.0.0/leaflet.markercluster.js'></script>
<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v1.0.0/MarkerCluster.css' rel='stylesheet' />
<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v1.0.0/MarkerCluster.Default.css' rel='stylesheet' />
<head>
<style>
table {
    border-collapse: collapse;
    width: 100%;
}

th, td {
    text-align: left;
    padding: 8px;
}

tr:nth-child(even){background-color: #f2f2f2}

th {
    background-color: #4CAF50;
    color: white;
}

</style>
<style type="text/css">
    html, body {
      margin: 0;
      padding: 0;
    }
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/4.5.1/firebase.js"></script>
  <script src="js/my_js.js"></script>
  <table id="report" border=1>
  <script>
var database = firebase.database();
var ref = database.ref('location');

ref.on('child_changed', function(childSnapshot) {
  document.getElementById('report').innerHTML=""; 
})

ref.on('child_removed', function(oldChildSnapshot) {
  document.getElementById('report').innerHTML=""; 
})

ref.on('value', gotData);



function gotData(data){

  var location = data.val();
  var keys = Object.keys(location);

  document.getElementById("report").innerHTML+= "<tr><th> Type Disaster<th> Information</tr>";
  for(var i=0;i<keys.length;i++){
    var k = keys[i];
    var name = location[k].name;
    var age = location[k].age;
    var casualties = location[k].casualties;
    var conNumber = location[k].contactNumber;
    var nMedic = location[k].needofmedication;
    var urgentN = location[k].urgentNeed;
    var latitude = location[k].latitude;
    var longitude = location[k].longitude;
    var typeDisaster = location[k].typeDisaster;
    var sevLevel = location[k].severityLevel;
    var date = location[k].date;
    

    document.getElementById("report").innerHTML+= "<tr><td><img  src=img/"+ typeDisaster + ".png height=42 width=42/></td><td><b>"+typeDisaster +"</b><br><b>Name: </b>"+ name + "<br><b>Age: </b>" + age +"<br><b>Contact Number: </b>" + conNumber +"<br><b>Casualties: </b>" + casualties + "<br><b>Need of medication: </b>" + nMedic + "<br><b>Urgent Need: </b>" + urgentN + "<br><b>Severity Level: </b>" + sevLevel + "<br><b>Date: </b>" + date + "<br><button class='view' lat="+ latitude + " lon="+ longitude + " value="+ k + ">View</button><button class='delete' value="+ k + ">Delete</button><br><br><input type='textarea' id='mes' name='mes' size=50% width=50%><button id='message' class='message' no="+i+" value="+ k + ">Message</button></tr>";
}

}

$(document).on('click', '.message', function() {
    var clicked = $(this).val();
    var no = $(this).attr('no');

    message = document.getElementsByName("mes")[no].value;
    if(message==""){
      alert('please enter message!');
      document.getElementsByName("mes")[no].focus();
      return false;
    }
    else{
        var refMessage = database.ref('location/' + clicked + '/message');

        refMessage.push({
          message: message,
          visit: 0
        });
        alert('Message has been sent to this victim!');
        window.location.replace('messageVictim.html');
    }

});

$(document).on('click', '.delete', function() {
    
    var clicked = $(this).val();
    
    var con = confirm("Are you sure want to delete this data?");
    if(con==true){
        alert("Data has been deleted");
        var ref = database.ref('location');
        ref.child(clicked).remove();
        return true;
    }
    else{
        return false;
    }
});

$(document).on('click', '.view', function() {
    
    var clicked = $(this).val();
    var lat = $(this).attr('lat');
    var lon = $(this).attr('lon');
    
    //alert(lat + lon);
    var delTable = document.getElementById("report");
          delTable.innerHTML="";

    document.getElementById('display').id = 'map'; 
    L.mapbox.accessToken = 'pk.eyJ1IjoicmlsZXhicmFkZXIiLCJhIjoiY2ozMDAxdnBmMDAzNTMzanMyMjJ5bTZsZyJ9.1KZbtlEhO7mfSELugWCqxA';

    var map = L.mapbox.map('map', 'mapbox.streets', {
      zoomControl: true,
      attributionControl: false,
      tileLayer: {
        maxNativeZoom: 19
      }
    }).setView([lat, lon], 100)
    L.control.locate().addTo(map);

//add stored location marker to mapbox - edited

var database = firebase.database();
var ref = database.ref('location');
ref.on('value', gotData);
var mark = {};


function gotData(data){

  var location = data.val();
  
  var keys = Object.keys(location);
  
    // The clusterGroup gets each marker in the group added to it
    // once loaded, and then is added to the map
  var mark = new L.MarkerClusterGroup();

  for(var i=0;i<keys.length;i++){
    var k = keys[i];
    var user = location[k].user;
    //console.log(user);
    var name = location[k].name;
    var age = location[k].age;
    var casualties = location[k].casualties;
    var conNumber = location[k].contactNumber;
    var nMedic = location[k].needofmedication;
    var urgentN = location[k].urgentNeed;
    var latitude = location[k].latitude;
    var longitude = location[k].longitude;
    var typeDisaster = location[k].typeDisaster;
    var sevLevel = location[k].severityLevel;
    var date = location[k].date;

    var geoJson = {
    type: 'FeatureCollection',
    features:[{
    "type": "Feature",
    "geometry": {
      "type": "Point",
      "coordinates": [longitude, latitude]
    },  
    "properties": {
      "title": typeDisaster,
      "description": 
      '#' + (i+1) + '<br>' +
      '<b>Name: </b>' + name + '<br>' +
      '<b>Age: </b>' + age + '<br>' +
      '<b>Contact: </b>' + conNumber + '<br>' +
      '<b>Casualties: </b>' + casualties + '<br>' +
      '<b>Need of Medication: </b>' + nMedic + '<br>' +
      '<b>Urgent Need: </b>' + urgentN + '<br>' +
      '<b>Severity Level: </b>' + sevLevel + '<br>' +
      '<b>Date: </b>' + date + '<br>' /*+
      '<button class="like" value='+ k + '>Like</button>' +
      '<button class="dislike" value='+ k + '>Dislike</button>' */
      ,
      image: 'img/'+ typeDisaster +'.png',
      "icon": {
              "iconUrl":"img/" + typeDisaster + ".png",
              "iconSize": [20, 25], // size of the icon
              "iconAnchor": [20, 25], // point of the icon which will correspond to marker's location
              "popupAnchor": [0, -25], // point from which the popup should open relative to the iconAnchor
              "className": "dot"
          }
    }
  }]
};
var myLayer = L.mapbox.featureLayer();
myLayer.on('layeradd', function(e) {
    var marker = e.layer,
        feature = marker.feature;

    marker.setIcon(L.icon(feature.properties.icon));
     var content = '<p><strong>' + feature.properties.title + '</strong><br>'+feature.properties.description +'</p><img src="' + feature.properties.image + '" height=50 width=60>';
  marker.bindPopup(content);
});

myLayer.setGeoJSON(geoJson);


mark.addLayer(myLayer);
map.addLayer(mark);
}
}

});
  </script>
  </table>
</head>
<body>
  <div id="display"></div>
</body>
</html>